<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo</title>
<style>
:root{
  --bg:#121212; --card:#1f1f1f; --accent:#3b82f6; --muted:#b0b0b0;
  --done:#22c55e; --pending:#ef4444; --hover:#333;
}
*{box-sizing:border-box;font-family: Vazirmatn, system-ui;}
body{margin:0;background:var(--bg);color:#fff;}
.container{max-width:980px;margin:20px auto;padding:10px;}
header{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;}
h1{margin:0;font-size:22px;color:var(--accent);}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
form{display:grid;grid-template-columns:1fr 150px;gap:8px;align-items:end;}
input[type=text],select{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;font-size:14px;}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;cursor:pointer;transition:0.2s;}
button:hover{background:#2563eb;color:#fff;}
.muted-btn{background:#333;color:#fff;border-radius:8px;padding:8px;border:1px solid #555;}
.muted-btn:hover{background:#444;}
.todo{padding:10px;border-radius:10px;margin-bottom:8px;background:var(--card);transition:0.3s;}
.todo.done{background:#183d1b; border:1px solid var(--done);}
.todo.pending{background:#3b1a1a; border:1px solid var(--pending);}
.empty{padding:20px;text-align:center;color:var(--muted);}
.day-card{display:inline-block;min-width:90px;padding:6px 10px;margin:4px;background:#2a2a2a;border-radius:10px;cursor:pointer;}
.day-card.selected{border:2px solid var(--accent);}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>لیست کارها</h1>
    <div id="calendar"></div>
  </header>
  <section class="card">
    <form id="taskForm">
      <input id="title" type="text" placeholder="عنوان کار" required />
      <select id="subject">
        <option value="شیمی">شیمی</option>
        <option value="فیزیک">فیزیک</option>
        <option value="ریاضی">ریاضی</option>
      </select>
      <button type="submit">افزودن کار</button>
    </form>
    <div id="todoList"></div>
    <div id="empty" class="empty" style="display:none;">هیچ کاری وجود ندارد</div>
  </section>
</div>

<script>
function toJalali(date){return new Intl.DateTimeFormat('fa-IR-u-ca-persian',{dateStyle:'full'}).format(date)}

let timers = {};
let timerStarts = {};
let selectedDate = new Date();

const listEl = document.getElementById('list');
const calendarSlider = document.getElementById('calendarSlider');
const titleEl = document.getElementById('title');
const subjectEl = document.getElementById('subject');

const API_URL = "https://nailonasadpour.ir/todo/api.php";

function formatDateKey(d){ return d.toISOString().split('T')[0]; }

// --- API Helpers ---
async function fetchTasks() {
    const res = await fetch(`${API_URL}?action=getTasks`);
    const data = await res.json();
    const tasksByDate = {};
    data.forEach(t => {
        const d = t.created_at.split(' ')[0];
        if(!tasksByDate[d]) tasksByDate[d] = [];
        tasksByDate[d].push({...t, subject: t.subject || "عمومی"});
    });
    return tasksByDate;
}

async function addTaskToServer(task){
    await fetch(`${API_URL}?action=addTask`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(task)
    });
}

async function updateTaskServer(id, done){
    await fetch(`${API_URL}?action=updateTask`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id, done})
    });
}

async function deleteTaskServer(id){
    await fetch(`${API_URL}?action=deleteTask&id=${id}`);
}

// --- Calendar ---
async function generateCalendar() {
    calendarSlider.innerHTML = '';
    const today = new Date();
    const tasks = await fetchTasks();

    for(let i=0; i<30; i++){
        const day = new Date(); day.setDate(today.getDate()+i);
        const key = formatDateKey(day);
        const card = document.createElement('div');
        card.className='day-card';
        card.dataset.date = key;
        card.innerHTML = `<div>${toJalali(day)}</div>`;

        const progressCircle = document.createElement('div');
        progressCircle.className = 'progress-circle';

        if(tasks[key] && tasks[key].length){
            const doneCount = tasks[key].filter(t=>t.done==1).length;
            const percent = Math.floor(doneCount/tasks[key].length*100);
            progressCircle.style.background=`conic-gradient(var(--done) 0% ${percent}%, #555 ${percent}% 100%)`;
            progressCircle.textContent = `${percent}%`;
        } else progressCircle.textContent='0%';

        card.appendChild(progressCircle);
        card.addEventListener('click',()=>{selectedDate=day; render(); highlightSelectedDay();});
        calendarSlider.appendChild(card);
    }
}

function highlightSelectedDay(){
    document.querySelectorAll('.day-card').forEach(c=>c.classList.remove('selected'));
    const selCard=document.querySelector(`.day-card[data-date='${formatDateKey(selectedDate)}']`);
    if(selCard) selCard.classList.add('selected');
}

// --- Render ---
async function render(){
    const key = formatDateKey(selectedDate);
    const tasksData = await fetchTasks();
    const visible = tasksData[key] || [];
    listEl.innerHTML = '';
    document.getElementById('empty').style.display = visible.length ? 'none':'block';

    visible.forEach(task=>{
        const el = document.createElement('div');
        el.className='todo '+(task.done==1?'done':'pending');

        const left = document.createElement('div');
        left.className='left';
        const h3 = document.createElement('h3'); h3.textContent = task.title;
        left.appendChild(h3);

        const meta = document.createElement('div'); meta.className='meta';
        const subj = document.createElement('div'); subj.className='subject-badge'; subj.textContent = task.subject;
        meta.appendChild(subj);
        left.appendChild(meta);

        // Timer
        const timerContainer = document.createElement('div'); timerContainer.className='timer-container';
        const timerDiv = document.createElement('div'); timerDiv.className='timer-circle';
        const timerText = document.createElement('span'); timerText.textContent = '00:00:00';
        timerDiv.appendChild(timerText);
        timerContainer.appendChild(timerDiv);
        left.appendChild(timerContainer);

        el.appendChild(left);

        // Actions
        const actions = document.createElement('div'); actions.className='actions';

        const doneBtn = document.createElement('button');
        doneBtn.textContent = task.done==1?'نشده کن':'انجام شد';
        doneBtn.addEventListener('click',async ()=>{
            await updateTaskServer(task.id, task.done==0?1:0);
            render(); generateCalendar();
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className='muted-btn';
        deleteBtn.textContent='حذف';
        deleteBtn.addEventListener('click', async ()=>{
            if(confirm('آیا از حذف این کار مطمئن هستید؟')){
                await deleteTaskServer(task.id);
                render(); generateCalendar();
            }
        });

        actions.appendChild(doneBtn);
        actions.appendChild(deleteBtn);
        el.appendChild(actions);

        listEl.appendChild(el);
    });
}

// --- Form ---
document.getElementById('taskForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const title = titleEl.value.trim();
    if(!title) return;
    const task = {title};
    await addTaskToServer(task);
    titleEl.value='';
    render();
    generateCalendar();
});

// --- Buttons ---
document.getElementById('todayBtn').addEventListener('click',()=>{selectedDate=new Date(); render(); highlightSelectedDay();});

// --- Init ---
generateCalendar();
highlightSelectedDay();
render();
</script>

</body>
</html>
