<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo</title>
<style>
:root{
  --bg:#121212; --card:#1f1f1f; --accent:#3b82f6; --muted:#b0b0b0;
  --done:#22c55e; --pending:#ef4444; --hover:#333;
}
*{box-sizing:border-box;font-family: Vazirmatn, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{margin:0;background:var(--bg);color:#fff;}
.container{max-width:980px;margin:20px auto;padding:10px;}
header{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;}
h1{margin:0;font-size:22px;color:var(--accent);}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
form{display:grid;grid-template-columns:1fr 150px;gap:8px;align-items:end;}
input[type=text],select,input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;font-size:14px;}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;cursor:pointer;transition:0.2s;}
button:hover{background:#2563eb;color:#fff;}
.muted-btn{background:#333;color:#fff;border-radius:8px;padding:8px;border:1px solid #555;transition:0.2s;}
.muted-btn:hover{background:#444;}
.list{margin-top:10px;}
.todo{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid #333;margin-bottom:8px;background:var(--card);flex-direction:column;transition:0.3s;position:relative;}
.todo.done{background:#183d1b; border-color:#22c55e;}
.todo.pending{background:#3b1a1a; border-color:#ef4444;}
.meta{font-size:13px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.subject-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#333;color:#fff;font-size:12px;}
.timer-container{display:flex;align-items:center;gap:8px;margin-top:6px;}
.timer-circle{width:70px;height:70px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#fff;flex-shrink:0;background: conic-gradient(var(--accent) 0% 0%, #555 0% 100%); transition: background 0.5s linear;}
.timer-circle span{position:relative;z-index:2;}
.calendar-slider{display:flex;overflow-x:auto;gap:12px;padding:8px 0;scroll-behavior:smooth;justify-content:flex-start;}
.calendar-slider::-webkit-scrollbar{display:none;}
.day-card{min-width:90px;padding:8px 10px;border-radius:12px;text-align:center;cursor:pointer;background:#2a2a2a;position:relative;flex-shrink:0;transition:0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.5);}
.day-card:hover{background:var(--hover);}
.day-card.selected{border:2px solid var(--accent);background:#3b3b3b;box-shadow:0 4px 10px rgba(0,0,0,0.8);}
.progress-circle{width:40px;height:40px;border-radius:50%;background:conic-gradient(var(--done) 0% 0%, #555 0% 100%);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#fff;margin:auto;margin-top:6px;transition:0.5s;}
.today-btn{position:fixed;top:12px;left:12px;padding:8px 12px;background:var(--accent);border:none;border-radius:10px;color:#000;cursor:pointer;z-index:10;transition:0.2s;}
.today-btn:hover{background:#2563eb;color:#fff;}
.empty{padding:20px;text-align:center;color:var(--muted);}
.auto-move-btn{margin-top:8px;background:#f59e0b;color:#000;border-radius:8px;padding:6px;border:0;cursor:pointer;}
.auto-move-btn:hover{background:#d97706;color:#fff;}
@media(max-width:720px){form{grid-template-columns:1fr} .calendar-slider{gap:4px} .day-card{min-width:70px;padding:6px 6px;font-size:12px}}
</style>
</head>
<body>
<div class="container">
<button class="today-btn" id="todayBtn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ²</button>
<header>
<h1>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ</h1>
<div class="calendar-slider" style="direction: ltr !important;" id="calendarSlider"></div>
</header>
<section class="card">
<form id="taskForm" autocomplete="off">
<div>
<label for="title">Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±</label>
<input id="title" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„ ØªÙ…Ø±ÛŒÙ† ÙØµÙ„ Û²" required />
</div>
<div>
<label for="subject">Ø¯Ø±Ø³</label>
<select id="subject">
<option value="Ø´ÛŒÙ…ÛŒ">Ø´ÛŒÙ…ÛŒ</option>
<option value="ÙÛŒØ²ÛŒÚ©">ÙÛŒØ²ÛŒÚ©</option>
<option value="Ø²ÛŒØ³Øª">Ø²ÛŒØ³Øª</option>
<option value="Ø±ÛŒØ§Ø¶ÛŒ">Ø±ÛŒØ§Ø¶ÛŒ</option>
<option value="Ø§Ø¯Ø¨ÛŒØ§Øª">Ø§Ø¯Ø¨ÛŒØ§Øª</option>
<option value="Ø¯ÛŒÙ†ÛŒ">Ø¯ÛŒÙ†ÛŒ</option>
<option value="Ø²Ø¨Ø§Ù†">Ø²Ø¨Ø§Ù†</option>
</select>
</div>
<div style="grid-column:1/-1">
<button id="addBtn" type="submit">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±</button>
<button id="clearCompleted" type="button" class="muted-btn">Ø­Ø°Ù Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
<button id="autoMoveBtn" type="button" class="auto-move-btn">Ø§Ù†ØªÙ‚Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø¨Ù‡ ÙØ±Ø¯Ø§</button>
</div>
</form>
<div class="list" id="list"></div>
<div id="empty" class="empty" style="display:none">Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€” ÛŒÚ© Ú©Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯!</div>
</section>
</div>
<script>
const API_URL = 'https://nailonasadpour.ir/todo/api.php';

let selectedDate = new Date();
const listEl = document.getElementById('todoList');
const titleEl = document.getElementById('title');
const subjectEl = document.getElementById('subject');
const calendarEl = document.getElementById('calendar');

// ğŸ“Œ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ³Ú©â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
async function fetchTasks(date){
  try {
    const res = await fetch(`${API_URL}?date=${date}`);
    return await res.json();
  } catch (e) {
    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§", e);
    return [];
  }
}

// ğŸ“Œ Ø§ÙØ²ÙˆØ¯Ù† ØªØ³Ú© Ø¬Ø¯ÛŒØ¯ ÛŒØ§ Ø¢Ù¾Ø¯ÛŒØª
async function saveTaskToServer(task){
  await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(task)
  });
}

// ğŸ“Œ Ø­Ø°Ù ØªØ³Ú©
async function deleteTaskServer(id){
  await fetch(API_URL, {
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
}

// ğŸ“Œ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
function formatDateKey(d){
  return d.toISOString().split('T')[0];
}

// ğŸ“Œ Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª
async function render(){
  const key = formatDateKey(selectedDate);
  const tasks = await fetchTasks(key);

  listEl.innerHTML = '';
  if(!tasks.length){
    document.getElementById('empty').style.display='block';
    return;
  } else {
    document.getElementById('empty').style.display='none';
  }

  tasks.forEach(task=>{
    const el=document.createElement('div');
    el.className='todo '+(task.done?'done':'pending');

    const left=document.createElement('div');
    left.className='left';

    const h3=document.createElement('h3');
    h3.textContent=task.title;
    left.appendChild(h3);

    const meta=document.createElement('div');
    meta.className='meta';
    const subj=document.createElement('div');
    subj.textContent=task.subject;
    subj.className='subject-badge';
    meta.appendChild(subj);
    left.appendChild(meta);

    // ğŸ¯ ØªØ§ÛŒÙ…Ø±
    const timer=document.createElement('div');
    timer.className='timer';
    let sec=0, interval=null;

    const timerEl=document.createElement('span');
    timerEl.textContent='00:00';
    timer.appendChild(timerEl);

    const startBtn=document.createElement('button');
    startBtn.textContent='Ø´Ø±ÙˆØ¹';
    startBtn.addEventListener('click', ()=>{
      if(interval) return;
      interval=setInterval(()=>{
        sec++;
        const m=Math.floor(sec/60).toString().padStart(2,'0');
        const s=(sec%60).toString().padStart(2,'0');
        timerEl.textContent=`${m}:${s}`;
      },1000);
    });
    timer.appendChild(startBtn);

    const pauseBtn=document.createElement('button');
    pauseBtn.textContent='ØªÙˆÙ‚Ù';
    pauseBtn.addEventListener('click', ()=>{
      clearInterval(interval);
      interval=null;
    });
    timer.appendChild(pauseBtn);

    const resetBtn=document.createElement('button');
    resetBtn.textContent='Ø±ÛŒØ³Øª';
    resetBtn.addEventListener('click', ()=>{
      sec=0; timerEl.textContent='00:00';
      clearInterval(interval); interval=null;
    });
    timer.appendChild(resetBtn);

    left.appendChild(timer);
    el.appendChild(left);

    const actions=document.createElement('div');
    actions.className='actions';

    const doneBtn=document.createElement('button');
    doneBtn.textContent=task.done?'Ù†Ø´Ø¯Ù‡ Ú©Ù†':'Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯';
    doneBtn.addEventListener('click', async ()=>{
      await saveTaskToServer({id:task.id, done:!task.done});
      render(); generateCalendar();
    });
    actions.appendChild(doneBtn);

    const deleteBtn=document.createElement('button');
    deleteBtn.textContent='Ø­Ø°Ù';
    deleteBtn.className='muted-btn';
    deleteBtn.addEventListener('click', async ()=>{
      if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')){
        await deleteTaskServer(task.id);
        render(); generateCalendar();
      }
    });
    actions.appendChild(deleteBtn);

    el.appendChild(actions);
    listEl.appendChild(el);
  });
}

// ğŸ“Œ ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† ØªØ³Ú©
document.getElementById('taskForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const title=titleEl.value.trim(); 
  if(!title) return;

  const task={
    title,
    subject:subjectEl.value,
    date:formatDateKey(selectedDate),
    goalMinutes:60
  };
  await saveTaskToServer(task);

  titleEl.value='';
  render(); generateCalendar();
});

// ğŸ“Œ ØªÙ‚ÙˆÛŒÙ…
async function generateCalendar(){
  calendarEl.innerHTML='';
  const base=new Date(selectedDate.getFullYear(), selectedDate.getMonth(),1);
  const today=formatDateKey(new Date());

  for(let i=0;i<30;i++){
    const d=new Date(base); d.setDate(d.getDate()+i);
    const key=formatDateKey(d);

    const cell=document.createElement('div');
    cell.className='calendar-day';
    cell.textContent=d.getDate();

    if(key===today) cell.classList.add('today');
    if(key===formatDateKey(selectedDate)) cell.classList.add('selected');

    const tasks=await fetchTasks(key);
    if(tasks.length){
      const dot=document.createElement('span');
      dot.className='dot'; cell.appendChild(dot);
    }

    cell.addEventListener('click',()=>{ selectedDate=d; render(); generateCalendar(); });
    calendarEl.appendChild(cell);
  }
}

// ğŸ“Œ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
render(); generateCalendar();
</script>

</body>
</html>
