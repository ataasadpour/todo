<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo</title>
<style>
:root{
  --bg:#121212; --card:#1f1f1f; --accent:#3b82f6; --muted:#b0b0b0;
  --done:#22c55e; --pending:#ef4444; --hover:#333;
}
*{box-sizing:border-box;font-family: Vazirmatn, system-ui;}
body{margin:0;background:var(--bg);color:#fff;}
.container{max-width:980px;margin:20px auto;padding:10px;}
header{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;}
h1{margin:0;font-size:22px;color:var(--accent);}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
form{display:grid;grid-template-columns:1fr 150px;gap:8px;align-items:end;}
input[type=text],select{width:100%;padding:8px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;font-size:14px;}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#000;cursor:pointer;transition:0.2s;}
button:hover{background:#2563eb;color:#fff;}
.muted-btn{background:#333;color:#fff;border-radius:8px;padding:8px;border:1px solid #555;}
.muted-btn:hover{background:#444;}
.todo{padding:10px;border-radius:10px;margin-bottom:8px;background:var(--card);transition:0.3s;}
.todo.done{background:#183d1b; border:1px solid var(--done);}
.todo.pending{background:#3b1a1a; border:1px solid var(--pending);}
.empty{padding:20px;text-align:center;color:var(--muted);}
.day-card{display:inline-block;min-width:90px;padding:6px 10px;margin:4px;background:#2a2a2a;border-radius:10px;cursor:pointer;}
.day-card.selected{border:2px solid var(--accent);}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>لیست کارها</h1>
    <div id="calendar"></div>
  </header>
  <section class="card">
    <form id="taskForm">
      <input id="title" type="text" placeholder="عنوان کار" required />
      <select id="subject">
        <option value="شیمی">شیمی</option>
        <option value="فیزیک">فیزیک</option>
        <option value="ریاضی">ریاضی</option>
      </select>
      <button type="submit">افزودن کار</button>
    </form>
    <div id="todoList"></div>
    <div id="empty" class="empty" style="display:none;">هیچ کاری وجود ندارد</div>
  </section>
</div>

<script>
// ================= API CONFIG =================
const API_URL = "https://nailonasadpour.ir/todo/api.php";

// ================= VARIABLES =================
let tasks = {};
let selectedDate = new Date();
const listEl = document.getElementById("todoList");
const calendarEl = document.getElementById("calendar");
const emptyEl = document.getElementById("empty");
const titleEl = document.getElementById("title");
const subjectEl = document.getElementById("subject");

// ================= HELPERS =================
function formatDateKey(d){ return d.toISOString().split("T")[0]; }
function toJalali(date){
  return new Intl.DateTimeFormat("fa-IR-u-ca-persian",{dateStyle:"full"}).format(date);
}

// ================= API FUNCTIONS =================
async function fetchTasks(){
  const res = await fetch(API_URL+"?action=get");
  tasks = await res.json();
  render();
  generateCalendar();
}
async function addTaskServer(task){
  await fetch(API_URL+"?action=add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(task)
  });
  fetchTasks();
}
async function updateTaskServer(task){
  await fetch(API_URL+"?action=update",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(task)
  });
  fetchTasks();
}
async function deleteTaskServer(id){
  await fetch(API_URL+"?action=delete",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id})
  });
  fetchTasks();
}

// ================= RENDER FUNCTIONS =================
function generateCalendar(){
  calendarEl.innerHTML = "";
  const today = new Date();
  for(let i=0;i<7;i++){
    const day = new Date();
    day.setDate(today.getDate()+i);
    const key = formatDateKey(day);
    const div = document.createElement("div");
    div.className="day-card";
    div.dataset.date=key;
    div.textContent=toJalali(day);
    if(key===formatDateKey(selectedDate)) div.classList.add("selected");
    div.addEventListener("click",()=>{
      selectedDate=day;
      render();
      generateCalendar();
    });
    calendarEl.appendChild(div);
  }
}

function render(){
  const key = formatDateKey(selectedDate);
  const dayTasks = tasks[key]||[];
  listEl.innerHTML="";
  if(dayTasks.length===0){ emptyEl.style.display="block"; return; }
  else emptyEl.style.display="none";

  dayTasks.forEach(t=>{
    const el = document.createElement("div");
    el.className="todo "+(t.done?"done":"pending");
    el.innerHTML=`<h3>${t.title}</h3><div>${t.subject}</div>`;
    const doneBtn=document.createElement("button");
    doneBtn.textContent=t.done?"نشده":"انجام شد";
    doneBtn.onclick=()=>{ t.done=!t.done; updateTaskServer(t); };
    const delBtn=document.createElement("button");
    delBtn.textContent="حذف";
    delBtn.className="muted-btn";
    delBtn.onclick=()=>deleteTaskServer(t.id);
    el.appendChild(doneBtn);
    el.appendChild(delBtn);
    listEl.appendChild(el);
  });
}

// ================= FORM HANDLER =================
document.getElementById("taskForm").addEventListener("submit",e=>{
  e.preventDefault();
  const key = formatDateKey(selectedDate);
  const task = {title:titleEl.value, subject:subjectEl.value, date:key, done:false};
  addTaskServer(task);
  titleEl.value="";
});

// ================= INIT =================
fetchTasks();
</script>
</body>
</html>
